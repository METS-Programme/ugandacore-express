<?xml version="1.0"?>

<!--
		Ant script to backup OpenMRS database This script needs the
		openmrs.properties file and ${dump.filname} propertie defined
	-->

<project name="createBackup" default="backup" basedir="${basedir}">

	<!--
		this is required to pick up the properties generated during the
		install pages
	-->
	<property file="${basedir}/ant.install.properties" />
	<property environment="env" />
	<property file="${env.INSTALLDIR}\openmrs.properties" />

	<!-- Backup OpenMRS database -->
	<target name="backup">

		<mkdir dir="${env.DESTINATIONDIR}\backup\" />

		<echo>Dump database in ${dump.filname}</echo>
		<exec executable="${mysql.dir}\bin\mysqldump.exe">
			<arg value="-B" />
			<arg value="-u" />
			<arg value="root" />
			<arg value="-P" />
			<arg value="${mysql.port}" />
			<arg value="openmrs" />
			<arg value="-r" />
			<arg value="${openmrs.dir}/backup/${dump.filname}" />
		</exec>

		<echo>Encrypt database dump</echo>
		<java classname="org.openmrs.bkp.util.CryptDump" fork="true">
			<arg value="${openmrs.dir}/backup/${dump.filname}" />
			<classpath>
				<pathelement location="${openmrs.dir}/script/lib/util.jar" />
				<pathelement path="${java.class.path}" />
				<pathelement path="${openmrs.dir}/script/lib/commons-lang-2.1.jar" />
				<pathelement path="${openmrs.dir}/script/lib/icu4j-4_0.jar" />
				<pathelement path="${openmrs.dir}/script/lib/jasypt-1.5.jar" />
				<pathelement path="${openmrs.dir}/script/lib/commons-codec-1.1.jar" />
			</classpath>
		</java>

		<delete file="${openmrs.dir}/backup/${dump.filname}" />

		<echo>Zip Encrypted database dump</echo>
		<zip destfile="${openmrs.dir}/backup/${dump.filname}.crpt.zip">
			<zipfileset dir="${openmrs.dir}/backup" includes="${dump.filname}.crpt" />
		</zip>

		<delete file="${openmrs.dir}/backup/${dump.filname}.crpt" />
	</target>
</project>
